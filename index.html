<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Landing Page JSON Builder - FAQ Under FAQ + Dark Mode</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Load SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>

  <header>
    <div class="header-inner">
      <h1>Landing Page JSON Builder</h1>
      <button id="darkModeToggle">Dark Mode</button>
    </div>
  </header>

  <!-- Top Row: Available vs. Selected -->
  <div class="container">
    <!-- LEFT: Available Components -->
    <div class="panel">
      <h2>Available Components</h2>
      <div id="availableList" class="available-components">
        <!-- Items from components.json will appear here -->
      </div>
    </div>

    <!-- RIGHT: Selected Components -->
    <div class="panel selected-panel">
      <h2>Selected Components</h2>
      <div id="selectedList" class="selected-list">
        <!-- Top-level items appear here -->
      </div>
      <button id="exportBtn" class="export-btn">Export JSON</button>
    </div>
  </div>

  <!-- Bottom #1: Form Editor -->
  <div class="form-editor">
    <h2>Component Fields</h2>
    <div id="formsContainer"></div>
  </div>

  <!-- Bottom #2: JSON Output -->
  <div class="json-output-panel">
    <h2>JSON Output</h2>
    <pre id="jsonOutput"></pre>
  </div>

  <script>
    // Dark Mode Toggle
    const darkToggleBtn = document.getElementById('darkModeToggle');
    darkToggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      darkToggleBtn.textContent = document.body.classList.contains('dark-mode')
        ? 'Light Mode'
        : 'Dark Mode';
    });

    // Global Data
    let componentsDefs = []; // from components.json
    let selectedItems = [];  // array of { compName, data, list (for FAQ), isFAQ: boolean }

    // 1) Load components.json
    fetch('./components.json')
      .then(res => res.json())
      .then(data => {
        componentsDefs = data;
        renderAvailableList();
        initSortableLeft();
        initSortableRight();
      })
      .catch(err => console.error('Error loading components.json:', err));

    // RENDER LEFT LIST
    function renderAvailableList() {
      const container = document.getElementById('availableList');
      container.innerHTML = '';
      componentsDefs.forEach(def => {
        const div = document.createElement('div');
        div.className = 'available-item';
        div.dataset.componentName = def.componentName;
        div.textContent = def.title || def.componentName;
        container.appendChild(div);
      });
    }

    // INIT SORTABLE FOR LEFT (Available)
    function initSortableLeft() {
      new Sortable(document.getElementById('availableList'), {
        group: {
          name: 'available',
          pull: 'clone',  // clone out
          put: false
        },
        sort: false,
        animation: 150
      });
    }

    // INIT SORTABLE FOR RIGHT (Top-level)
    function initSortableRight() {
      new Sortable(document.getElementById('selectedList'), {
        group: {
          name: 'selected',
          put: ['available', 'faq-child', 'selected'] // accept from left or reorder
        },
        animation: 150,

        onAdd: (evt) => {
          const draggedEl = evt.item;
          const compName = draggedEl.dataset.componentName;
          const def = getDef(compName);
          if (!def) return;

          const newObj = createDataObject(def);

          // Insert into top-level array
          selectedItems.splice(evt.newIndex, 0, newObj);
          renderSelectedList();
          renderForms();

          draggedEl.remove(); // remove cloned DOM
        },

        onUpdate: (evt) => {
          const { oldIndex, newIndex } = evt;
          if (oldIndex === newIndex) return;
          const moved = selectedItems.splice(oldIndex, 1)[0];
          selectedItems.splice(newIndex, 0, moved);

          renderSelectedList();
          renderForms();
        }
      });
    }

    // Get definition object by componentName
    function getDef(name) {
      return componentsDefs.find(d => d.componentName === name);
    }

    // Create data object for a new item
    // If it's "faq", we store `list: []` to hold multiple Q/A items
    function createDataObject(def) {
      const dataObj = {};
      (def.fields || []).forEach(f => { dataObj[f.name] = ''; });
      return {
        componentName: def.componentName,
        title: def.title || def.componentName,
        data: dataObj,
        list: [], // For "faq" items, we store Q/A children here
        arrayKey: def.arrayKey || null,        // e.g. "list" for FAQ
        allowedChildType: def.allowedChildType || null
      };
    }

    // RENDER SELECTED LIST (TOP LEVEL)
    function renderSelectedList() {
      const selContainer = document.getElementById('selectedList');
      selContainer.innerHTML = '';

      selectedItems.forEach((item, index) => {
        // Each item
        const itemDiv = document.createElement('div');
        itemDiv.className = 'selected-item';
        itemDiv.dataset.index = index;

        // Header: title + remove
        const header = document.createElement('div');
        header.className = 'selected-header';

        const span = document.createElement('span');
        span.className = 'title';
        span.textContent = (index + 1) + ') ' + item.title;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => {
          selectedItems.splice(index, 1);
          renderSelectedList();
          renderForms();
        });

        header.appendChild(span);
        header.appendChild(removeBtn);
        itemDiv.appendChild(header);

        // If it's an FAQ container, add a child-list area
        if (item.arrayKey) {
          // create a .child-list container
          const childListDiv = document.createElement('div');
          childListDiv.className = 'child-list';
          childListDiv.dataset.index = index; // so we know which FAQ

          itemDiv.appendChild(childListDiv);

          // Sortable for the FAQ's child area
          initFAQChildSortable(childListDiv, item);
          // Render existing Q/A (list) as sub-items
          renderChildItems(item.list, childListDiv, index);
        }

        selContainer.appendChild(itemDiv);
      });
    }

    // Initialize Sortable for FAQ child zone
    function initFAQChildSortable(childListDiv, parentItem) {
      new Sortable(childListDiv, {
        group: {
          name: 'faq-child',
          put: ['available'], // can drop from the left
          pull: false         // don't drag out from here
        },
        animation: 150,
        onAdd: (evt) => {
          const draggedEl = evt.item;
          const compName = draggedEl.dataset.componentName;
          const def = getDef(compName);
          if (!def) return;

          // Ensure the parent's 'allowedChildType' matches this compName
          if (parentItem.allowedChildType !== compName) {
            // If you want to block or revert the drop, do so here:
            // e.g., childListDiv.removeChild(draggedEl);
            // or just do nothing. We'll remove the draggedEl anyway.
            draggedEl.remove();
            alert(`This FAQ only accepts '${parentItem.allowedChildType}', not '${compName}'.`);
            return;
          }

          // Create Q/A item
          const childObj = createDataObject(def);
          // Append to parent's list
          parentItem.list.splice(evt.newIndex, 0, childObj);

          renderSelectedList();
          renderForms();

          draggedEl.remove();
        }
      });
    }

    // RENDER CHILD ITEMS (Q/A) INSIDE THE FAQ
    function renderChildItems(listArray, container, parentIndex) {
      container.innerHTML = ''; // clear first

      listArray.forEach((faqItem, cIndex) => {
        // Each Q/A
        const subDiv = document.createElement('div');
        subDiv.className = 'selected-item'; 
        subDiv.style.cursor = 'default'; // no reordering child items in this example

        const header = document.createElement('div');
        header.className = 'selected-header';

        const span = document.createElement('span');
        span.className = 'title';
        span.textContent = (cIndex + 1) + ') ' + faqItem.title;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => {
          listArray.splice(cIndex, 1);
          renderSelectedList();
          renderForms();
        });

        header.appendChild(span);
        header.appendChild(removeBtn);
        subDiv.appendChild(header);

        container.appendChild(subDiv);
      });
    }

    // RENDER FORMS (Card-style)
    function renderForms() {
      const formsContainer = document.getElementById('formsContainer');
      formsContainer.innerHTML = '';

      // For each top-level item
      selectedItems.forEach((item, idx) => {
        renderFormItem(item, idx, formsContainer);

        // If it's FAQ, also render forms for each Q/A in item.list
        if (item.arrayKey && item.arrayKey === 'list') {
          item.list.forEach((childObj, cIndex) => {
            renderFormItem(childObj, cIndex, formsContainer, /*indent*/ 1);
          });
        }
      });
    }

    // A function to render a single "component" form
    function renderFormItem(item, index, parentEl, indentLevel = 0) {
      const formDiv = document.createElement('div');
      formDiv.className = 'component-form';
      // Optional indentation for child forms
      formDiv.style.marginLeft = (indentLevel * 20) + 'px';

      const title = document.createElement('h3');
      title.textContent = (index + 1) + ') ' + item.title + ' Fields';
      formDiv.appendChild(title);

      // Build fields
      const def = getDef(item.componentName);
      if (def && def.fields) {
        def.fields.forEach(field => {
          const group = document.createElement('div');
          group.className = 'field-group';

          const label = document.createElement('label');
          label.textContent = field.label;

          const input = document.createElement('input');
          input.type = field.type || 'text';
          input.value = item.data[field.name] || '';
          input.placeholder = 'Enter ' + field.label;
          input.addEventListener('input', e => {
            item.data[field.name] = e.target.value;
          });

          group.appendChild(label);
          group.appendChild(input);
          formDiv.appendChild(group);
        });
      }

      parentEl.appendChild(formDiv);
    }

    // EXPORT JSON
    document.getElementById('exportBtn').addEventListener('click', () => {
      // We transform each top-level item into final JSON
      const finalArray = selectedItems.map(item => convertToFinalJson(item));

      // Example final root object
      // If item.componentName = 'faq', we produce an object like:
      // {
      //   "type": "FAQ",
      //   "list": [ ... ]
      // }
      // If it's "pricing-table", etc., handle differently.
      const finalOutput = { landingPage: finalArray };

      document.getElementById('jsonOutput').textContent = JSON.stringify(finalOutput, null, 2);
    });

    // Convert an item to final JSON structure
    function convertToFinalJson(item) {
      const def = getDef(item.componentName);
      if (!def) return {};

      // If item is "faq":
      if (item.arrayKey === 'list') {
        // We'll produce an object with "type": "FAQ" (or item.componentName),
        // plus "list": an array of Q/A objects
        // The item.data is likely empty for the parent FAQ container
        // The real Q/A data is in item.list
        const listArray = item.list.map(q => {
          // Each "faq-item" has question/answer in q.data
          return {
            question: q.data['question'] || '',
            answer:   q.data['answer']   || ''
          };
        });
        return {
          type: "FAQ",          // or item.componentName.toUpperCase()
          list: listArray
        };
      } else if (item.componentName === 'pricing-table') {
        // example: build a custom structure
        return {
          type: "PRICING_TABLE",
          title: item.data.title,
          plan1Name:  item.data.plan1Name,
          plan1Price: item.data.plan1Price
        };
      } else {
        // fallback for other components
        return {
          type: (item.componentName || "UNKNOWN"),
          ...item.data
        };
      }
    }
  </script>
</body>
</html>
