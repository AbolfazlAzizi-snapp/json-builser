<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Landing Page JSON Builder - Advanced Drag & Drop</title>
  <link rel="stylesheet" href="style.css" />

  <!-- SortableJS (via CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>

  <header>
    <h1>Landing Page JSON Builder</h1>
  </header>

  <!-- TOP ROW: Available vs. Selected -->
  <div class="container">
    <!-- LEFT: Available Components Panel -->
    <div class="panel">
      <h2>Available Components</h2>
      <div id="availableList" class="available-components">
        <!-- We will create .available-item elements in JS -->
      </div>
    </div>

    <!-- RIGHT: Selected Components Panel -->
    <div class="panel selected-panel">
      <h2>Selected Components</h2>
      <div id="selectedList" class="selected-list">
        <!-- Items get dropped/cloned here from "availableList", can reorder -->
      </div>
      <button id="exportBtn" class="export-btn">Export JSON</button>
    </div>
  </div>

  <!-- BOTTOM #1: Form Editor (Card for each selected component) -->
  <div class="form-editor">
    <h2>Component Fields</h2>
    <div id="formsContainer"></div>
  </div>

  <!-- BOTTOM #2: JSON Output Panel -->
  <div class="json-output-panel">
    <h2>JSON Output</h2>
    <pre id="jsonOutput"></pre>
  </div>

  <script>
    let componentsDefs = [];      // The library from components.json
    let selectedComponents = [];  // array of { definition, data }

    // 1) Load components.json
    fetch('./components.json')
      .then(res => res.json())
      .then(data => {
        componentsDefs = data;
        renderAvailableList();  // show the items in left panel
        initSortables();        // set up drag & drop
      })
      .catch(err => console.error('Error loading components.json:', err));

    // RENDER AVAILABLE LIST
    function renderAvailableList() {
      const container = document.getElementById('availableList');
      container.innerHTML = '';

      // For each definition, create a div.available-item
      componentsDefs.forEach(def => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'available-item';
        itemDiv.textContent = def.componentName;
        // Store the name in a data attribute for identification
        itemDiv.dataset.componentName = def.componentName;

        container.appendChild(itemDiv);
      });
    }

    // INITIALIZE TWO LISTS (SORTABLEJS)
    function initSortables() {
      // Left list: 'available'
      new Sortable(document.getElementById('availableList'), {
        group: {
          name: 'available',
          pull: 'clone',  // clone items when dragged out
          put: false      // don't allow dropping items back here
        },
        sort: false, // can't reorder in the "available" list
        animation: 150
      });

      // Right list: 'selected'
      new Sortable(document.getElementById('selectedList'), {
        group: {
          name: 'selected',
          put: ['available', 'selected'] // accept from these lists
        },
        animation: 150,

        // onAdd: item dragged from left to right
        onAdd: evt => {
          const draggedEl = evt.item; 
          const compName = draggedEl.dataset.componentName; 

          // Find definition in componentsDefs
          const def = componentsDefs.find(d => d.componentName === compName);
          if (!def) return;

          // Create a fresh data object for its fields
          const dataObj = {};
          def.fields.forEach(f => { dataObj[f.name] = ''; });

          // Insert into selectedComponents at the correct index
          selectedComponents.splice(evt.newIndex, 0, { definition: def, data: dataObj });

          // Re-render list & forms
          renderSelectedList();
          renderForms();

          // Remove the cloned DOM element (we rely on renderSelectedList() to create standard markup)
          draggedEl.remove();
        },

        // onUpdate: user reorders items inside "selectedList"
        onUpdate: evt => {
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          if (oldIndex === newIndex) return;

          // Move the item in selectedComponents to match
          const movedItem = selectedComponents.splice(oldIndex, 1)[0];
          selectedComponents.splice(newIndex, 0, movedItem);

          renderSelectedList();
          renderForms();
        }
      });
    }

    // RENDER SELECTED LIST (RIGHT PANEL)
    function renderSelectedList() {
      const selContainer = document.getElementById('selectedList');
      selContainer.innerHTML = '';

      selectedComponents.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'selected-item';

        const span = document.createElement('span');
        span.textContent = (index + 1) + ') ' + item.definition.componentName;

        // Remove button
        const btnRemove = document.createElement('button');
        btnRemove.textContent = 'Remove';
        btnRemove.className = 'remove-btn';
        btnRemove.addEventListener('click', () => {
          selectedComponents.splice(index, 1);
          renderSelectedList();
          renderForms();
        });

        div.appendChild(span);
        div.appendChild(btnRemove);
        selContainer.appendChild(div);
      });
    }

    // RENDER FORMS (BOTTOM)
    function renderForms() {
      const formsContainer = document.getElementById('formsContainer');
      formsContainer.innerHTML = '';

      selectedComponents.forEach((item, idx) => {
        const formDiv = document.createElement('div');
        formDiv.className = 'component-form';

        // Title for each component's form
        const title = document.createElement('h3');
        title.textContent = (idx + 1) + ') ' + item.definition.componentName + ' Fields';
        formDiv.appendChild(title);

        // Create field inputs
        item.definition.fields.forEach(field => {
          const fieldGroup = document.createElement('div');
          fieldGroup.className = 'field-group';

          const label = document.createElement('label');
          label.textContent = field.label;

          const input = document.createElement('input');
          input.type = field.type || 'text';
          input.value = item.data[field.name];
          input.placeholder = 'Enter ' + field.label;
          input.addEventListener('input', (e) => {
            item.data[field.name] = e.target.value;
          });

          fieldGroup.appendChild(label);
          fieldGroup.appendChild(input);
          formDiv.appendChild(fieldGroup);
        });

        formsContainer.appendChild(formDiv);
      });
    }

    // EXPORT JSON
    document.getElementById('exportBtn').addEventListener('click', () => {
      const output = selectedComponents.map(sc => ({
        componentName: sc.definition.componentName,
        fields: { ...sc.data }
      }));
      const finalJson = { landingPage: output };

      document.getElementById('jsonOutput').textContent = JSON.stringify(finalJson, null, 2);
    });
  </script>
</body>
</html>
